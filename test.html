<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      const _t = +new Date();
      const sleep = t =>
        new Promise(resolve => setTimeout(() => resolve("123"), t));

      async function test() {
        const data = await sleep(1000);
        console.log("data: ", data);
        const data2 = await sleep(1000);
        console.log("data2: ", data2);
        return "success";
      }

      // 1秒后打印data 再过一秒打印data2 最后打印success
      // test().then(res => console.log(res));

      function* testG(arg) {
        console.log(arg);
        // await被编译成了yield
        const data = yield sleep(1000);
        console.log("data: ", data);
        const data2 = yield sleep(1000);
        console.log("data2: ", data2);
        return "success";
      }
      /*
      将generator函数进行自动执行
      实现async await 的功能
      */
      function asyncToGenerator(fn, ...arg) {
        const gen = fn(...arg);
        return new Promise((resolve, reject) => {
          function step(key, arg) {
            let generatorResult;
            try {
              generatorResult = gen[key](arg);
            } catch (error) {
              return reject(error);
            }
            const { value, done } = generatorResult;
            if (done) {
              return resolve(value);
            } else {
              return Promise.resolve(value).then(
                val => step("next", val),
                err => step("throw", err)
              );
            }
          }
          step("next");
        });
      }
      asyncToGenerator(testG).then(console.log);
    </script>
  </body>
</html>
